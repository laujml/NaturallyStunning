<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Naturally Stunning</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/carrito.css">
</head>
<body>
    <input type="checkbox" id="menu-toggle" style="display: none;">
    <aside id="sidebar" class="sidebar"></aside>
    
    <div id="content"> 
        <div id="topbar-placeholder"></div>

        <section class="carrito-hero">
            <h1>CARRITO DE COMPRAS</h1>
            <p>Revisa tus productos</p>
        </section>

        <section class="carrito-container">
            <div class="carrito-items">
                <h2>Productos (<span id="items-count">0</span>)</h2>
                <div id="cart-items"></div>
            </div>

            <div class="carrito-summary">
                <h3>Resumen</h3>
                <div class="summary-line">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="summary-line">
                    <span>Envío:</span>
                    <span>$5.00</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-total">
                    <span>TOTAL</span>
                    <span id="total">$5.00</span>
                </div>
                <button class="btn-checkout" onclick="checkout()">Pagar</button>
            </div>
        </section>

        <footer>
            <p>© 2025 Naturally Stunning</p>
        </footer>
    </div>

    <script src="js/topbar_data.js"></script>
    <script src="js/sidebar_data.js"></script>
    <script>
        document.getElementById('topbar-placeholder').innerHTML = TOPBAR_HTML;
        document.getElementById('sidebar').innerHTML = SIDEBAR_CONTENT;
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9FwgsInMEb1_0lrFTFQ0mkjbzrDAsjLk",
            authDomain: "naturallystunning.firebaseapp.com",
            projectId: "naturallystunning",
            storageBucket: "naturallystunning.firebasestorage.app",
            messagingSenderId: "590111432564",
            appId: "1:590111432564:web:8637bef1adff878a6a9621"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let cartListener = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const cartRef = doc(db, "carts", user.uid);
            cartListener = onSnapshot(cartRef, (docSnap) => {
                const cart = docSnap.exists() ? docSnap.data().items : [];
                renderCart(cart);
            });
        });

        function renderCart(cart) {
            const container = document.getElementById('cart-items');
            const count = document.getElementById('items-count');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');

            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:40px;">Carrito vacío</p>';
                count.textContent = '0';
                subtotalEl.textContent = '$0.00';
                totalEl.textContent = '$5.00';
                return;
            }

            let subtotal = 0;
            container.innerHTML = '';
            count.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            cart.forEach(item => {
                subtotal += item.price * item.quantity;
                const div = document.createElement('div');
                div.className = 'carrito-item';
                div.innerHTML = `
                    <div class="item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="item-info">
                        <h3>${item.name}</h3>
                        <p class="item-price">$${item.price.toFixed(2)}</p>
                    </div>
                    <div class="item-quantity">
                        <label>Cantidad:</label>
                        <input type="number" value="${item.quantity}" min="1" onchange="updateQty('${item.id}', this.value)">
                    </div>
                    <div class="item-actions">
                        <span class="item-price">$${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="btn-remove" onclick="removeItem('${item.id}')">Eliminar</button>
                    </div>
                `;
                container.appendChild(div);
            });

            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            totalEl.textContent = `$${(subtotal + 5).toFixed(2)}`;
        }

        window.updateQty = async (id, qty) => {
            const user = auth.currentUser;
            const cartRef = doc(db, "carts", user.uid);
            const cartSnap = await getDoc(cartRef);
            let cart = cartSnap.data().items;
            
            const index = cart.findIndex(item => item.id === id);
            cart[index].quantity = parseInt(qty);
            
            await setDoc(cartRef, { items: cart, updatedAt: new Date().toISOString() });
        };

        window.removeItem = async (id) => {
            const user = auth.currentUser;
            const cartRef = doc(db, "carts", user.uid);
            const cartSnap = await getDoc(cartRef);
            let cart = cartSnap.data().items.filter(item => item.id !== id);
            
            await setDoc(cartRef, { items: cart, updatedAt: new Date().toISOString() });
        };

        window.checkout = async () => {
            const user = auth.currentUser;
            const cartRef = doc(db, "carts", user.uid);
            await setDoc(cartRef, { items: [], updatedAt: new Date().toISOString() });
            alert('¡Compra realizada con éxito!');
        };
    </script>
</body>
</html>
