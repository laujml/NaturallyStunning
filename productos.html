<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - Naturally Stunning</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/productos.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <input type="checkbox" id="menu-toggle" style="display: none;">
    <aside id="sidebar" class="sidebar"></aside>
    
    <div id="content"> 
        <div id="topbar-placeholder"></div>
                
        <section class="productos-hero">
            <h1>NUESTROS PRODUCTOS</h1>
            <p>Descubre nuestra selecci√≥n de productos naturales para el cuidado de tu piel</p>
        </section>

        <section class="productos-catalogo">
            <div class="productos-grid" id="products-grid">
                <!-- Los productos se cargan aqu√≠ din√°micamente -->
            </div>
        </section>

        <!-- MODAL DE DETALLES -->
        <div id="product-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="modal-close">&times;</span>
                <div class="modal-body" id="modal-body"></div>
            </div>
        </div>
        
        <footer>
            <p>¬© 2025 Naturally Stunning - Todos los derechos reservados</p>
            <p>Creado por Laura Angel y Jorge Flores</p>
        </footer>
    </div>

    <script src="js/topbar_data.js"></script>
    <script src="js/sidebar_data.js"></script>
    <script src="js/data/Products.js"></script>
    <script>
        document.getElementById('topbar-placeholder').innerHTML = TOPBAR_HTML;
        document.getElementById('sidebar').innerHTML = SIDEBAR_CONTENT;
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9FwgsInMEb1_0lrFTFQ0mkjbzrDAsjLk",
            authDomain: "naturallystunning.firebaseapp.com",
            projectId: "naturallystunning",
            storageBucket: "naturallystunning.firebasestorage.app",
            messagingSenderId: "590111432564",
            appId: "1:590111432564:web:8637bef1adff878a6a9621"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Cargar productos desde Products.js
        const products = getAllProducts();
        const grid = document.getElementById('products-grid');
        const modal = document.getElementById('product-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');

        console.log('üì¶ Cargando', products.length, 'productos...');

        // Renderizar todos los productos
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'producto-card';
            
            const categoryNames = {
                'skincare': 'Cuidado de la Piel',
                'makeup': 'Maquillaje',
                'accessories': 'Accesorios'
            };
            
            card.innerHTML = `
                <div class="producto-image">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='img/placeholder.png'">
                </div>
                <div class="producto-info">
                    <h3>${product.name}</h3>
                    <p class="producto-descripcion">${product.description.substring(0, 120)}...</p>
                    <div class="producto-footer">
                        <span class="producto-precio">$${product.price.toFixed(2)} USD</span>
                        <div style="display:flex;gap:10px;justify-content:space-between;">
                            <button class="btn btn-agregar" onclick="addToCart('${product.id}')">
                                üõí Agregar
                            </button>
                            <button class="btn btn-ver" onclick="showModal('${product.id}')">
                                üëÅÔ∏è Ver m√°s
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });

        console.log('‚úÖ Productos renderizados');

        // Funci√≥n para mostrar modal con detalles completos
        window.showModal = (id) => {
            const product = getProductById(id);
            if (!product) {
                console.error('Producto no encontrado:', id);
                return;
            }
            
            console.log('üìÑ Mostrando modal para:', product.name);
            
            const categoryNames = {
                'skincare': 'Cuidado de la Piel',
                'makeup': 'Maquillaje',
                'accessories': 'Accesorios'
            };
            
            modalBody.innerHTML = `
                <h2>${product.name}</h2>
                <img src="${product.image}" alt="${product.name}" onerror="this.src='img/placeholder.png'">
                
                <div class="modal-details">
                    <p><strong>Categor√≠a:</strong> ${categoryNames[product.category] || product.category}</p>
                    
                    <p><strong>Precio:</strong> <span class="modal-price">$${product.price.toFixed(2)} USD</span></p>
                    
                    ${product.originalPrice ? 
                        `<p><strong>Precio original:</strong> <s style="color:#999;">$${product.originalPrice.toFixed(2)} USD</s> 
                        <span style="color:#e74c3c;font-weight:600;margin-left:10px;">
                            ¬°Ahorra ${Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100)}%!
                        </span></p>` 
                        : ''}
                    
                    <p><strong>Descripci√≥n:</strong><br>${product.description}</p>
                    
                    ${product.benefits && product.benefits.length > 0 ? `
                        <p style="margin-top:20px;"><strong>Beneficios:</strong></p>
                        <ul>
                            ${product.benefits.map(b => `<li>‚úì ${b}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    ${product.ingredients && product.ingredients.length > 0 ? `
                        <p style="margin-top:20px;"><strong>Ingredientes principales:</strong></p>
                        <ul>
                            ${product.ingredients.map(i => `<li>üåø ${i}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    ${product.colors && product.colors.length > 0 ? `
                        <p style="margin-top:20px;"><strong>Colores disponibles:</strong> ${product.colors.join(', ')}</p>
                    ` : ''}
                    
                    <p style="margin-top:20px;"><strong>Disponibilidad:</strong> 
                        ${product.stock > 0 ? 
                            `<span style="color:#27ae60;">‚úì ${product.stock} unidades en stock</span>` : 
                            `<span style="color:#e74c3c;">‚úó Agotado</span>`}
                    </p>
                    
                    ${product.featured ? '<p style="color:#f39c12;font-weight:600;">‚≠ê Producto Destacado</p>' : ''}
                    ${product.bestSeller ? '<p style="color:#27ae60;font-weight:600;">üèÜ Best Seller</p>' : ''}
                    ${product.bundle ? '<p style="color:#3498db;font-weight:600;">üì¶ Set Completo</p>' : ''}
                    
                    <button class="btn btn-agregar" 
                            style="width:100%;margin-top:30px;padding:15px;font-size:1.1rem;"
                            onclick="addToCart('${product.id}'); closeModal();"
                            ${product.stock <= 0 ? 'disabled' : ''}>
                        ${product.stock > 0 ? 
                            `‚úì Agregar al Carrito - $${product.price.toFixed(2)} USD` : 
                            'Producto Agotado'}
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        };

        // Funci√≥n para cerrar modal
        window.closeModal = () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Event listeners para cerrar modal
        modalClose.onclick = closeModal;
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };

        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                closeModal();
            }
        });

        // Funci√≥n para agregar al carrito
        window.addToCart = async (id) => {
            const product = getProductById(id);
            if (!product) {
                alert('‚ùå Producto no encontrado');
                return;
            }

            if (product.stock <= 0) {
                alert('‚ùå Este producto est√° agotado');
                return;
            }
            
            const user = auth.currentUser;
            
            if (!user) {
                if (confirm('Debes iniciar sesi√≥n para agregar productos al carrito.\n\n¬øIr a la p√°gina de login?')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            try {
                const cartRef = doc(db, "carts", user.uid);
                const cartSnap = await getDoc(cartRef);
                let cart = cartSnap.exists() ? cartSnap.data().items || [] : [];
                
                const existingIndex = cart.findIndex(item => item.id === id);
                
                if (existingIndex > -1) {
                    // Verificar stock antes de incrementar
                    if (cart[existingIndex].quantity >= product.stock) {
                        alert(`‚ùå No hay m√°s stock disponible (m√°ximo: ${product.stock} unidades)`);
                        return;
                    }
                    cart[existingIndex].quantity += 1;
                } else {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: 1,
                        category: product.category
                    });
                }

                await setDoc(cartRef, { 
                    items: cart, 
                    updatedAt: new Date().toISOString() 
                });
                
                showNotification(`‚úÖ ${product.name} agregado al carrito`);
                
            } catch (error) {
                console.error('Error al agregar al carrito:', error);
                alert('‚ùå Error al agregar al carrito. Por favor intenta de nuevo.');
            }
        };

        // Funci√≥n para mostrar notificaci√≥n
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Agregar estilos de animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        console.log(' P√°gina de productos lista');
    </script>
</body>
</html>
